name: Build

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch or tag (develop, feature/x, v1.2.0)"
        required: true
        default: "develop"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout selected ref
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      # -----------------------------
      # Determine RELEASE_TYPE
      # -----------------------------
      - name: Determine release type
        id: rel
        run: |
          REF="${{ github.event.inputs.ref }}"
          if [[ "$REF" == "develop" ]]; then
            echo "type=alpha" >> $GITHUB_OUTPUT
          elif [[ "$REF" == feature/* ]]; then
            echo "type=feature" >> $GITHUB_OUTPUT
          elif [[ "$REF" == v* ]]; then
            echo "type=production" >> $GITHUB_OUTPUT
          else
            echo "type=dev" >> $GITHUB_OUTPUT
          fi

      # -----------------------------
      # Build using Makefile
      # -----------------------------
      - name: Build
        run: |
          make \
            GIT_REF=${{ github.event.inputs.ref }} \
            COMMIT_SHA=$(git rev-parse HEAD) \
            RELEASE_TYPE=${{ steps.rel.outputs.type }} \
            | tee -a logs/build.log

      # -----------------------------
      # Upload logs (ALWAYS)
      # -----------------------------
      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ github.event.inputs.ref }}
          path: logs/build.log

      # -----------------------------
      # Upload build artifacts
      # -----------------------------
      - name: Upload build output
        uses: actions/upload-artifact@v4
        with:
          name: build-output-${{ github.event.inputs.ref }}
          path: output/

      # -----------------------------
      # GitHub Release (tags only)
      # -----------------------------
      - name: Upload to GitHub Release
        if: startsWith(github.event.inputs.ref, 'v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.ref }}
          files: |
            output/*
            logs/build.log
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

